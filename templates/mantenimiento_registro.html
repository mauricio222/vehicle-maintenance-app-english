<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><script>if(window.matchMedia("(max-width: 1440px)").matches){var viewport=document.querySelector("meta[name=viewport]");viewport&&viewport.setAttribute("content","width=device-width,initial-scale=0.5")}</script><title>Maintenance Registration</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css"><style>#tablaMantenimientos{border:none}#tablaMantenimientos th,#tablaMantenimientos td{border:none}#tablaMantenimientos thead th{border-bottom:2px solid #dee2e6}.card{border:none;box-shadow:none}.dataTables_wrapper .row:first-child,.dataTables_wrapper .row:last-child{border:none;margin:0;padding:0}.dataTables_wrapper .row{margin:0}.container.mt-4{margin-left:auto!important;margin-right:auto!important;text-align:left}@media (max-width:1440px){.container.mt-4{margin-left:0!important;margin-right:auto!important}}.search-container{margin-bottom:20px}#searchInput{width:100%;padding:8px 12px;border-radius:4px;border:1px solid #ced4da}</style></head><body><div class="container mt-4"><div class="d-flex justify-content-between align-items-center mb-4"><div><h1 class="mb-2">Maintenance Registration</h1></div><div><a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back</a> {% if g.user %}<a href="{{ url_for('logout') }}" class="btn btn-danger ms-2">Logout ({{ g.user.username }})</a>{% endif %}</div></div><div id="mensajeContainer" style="display:none" class="alert alert-dismissible fade show mb-3" role="alert"><span id="mensajeTexto"></span><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div><div class="card"><div class="card-body"><form id="mantenimientoForm"><div class="card mb-3"><div class="card-body"><h6 class="card-subtitle mb-3">Vehicle Information</h6><div class="row"><div class="col-md-4"><div class="mb-3"><label for="vehiculo" class="form-label">Vehicle</label><select class="form-select" id="vehiculo" name="vehiculo" required data-placeholder="Select a vehicle"><option></option>{% for vehiculo in vehiculos %}<option value="{{ vehiculo.id }}">{{ vehiculo.alias }} - {{ vehiculo.marca }} {{ vehiculo.modelo }} ({{ vehiculo.anio }})</option>{% endfor %}</select></div></div><div class="col-md-4"><div class="mb-3"><label for="fecha" class="form-label">Date</label><input type="text" class="form-control" id="fecha" name="fecha" placeholder="dd/mm/yyyy" required></div></div><div class="col-md-4"><div class="mb-3"><label for="kilometraje" class="form-label">Mileage</label><input type="text" class="form-control" id="kilometraje" name="kilometraje" pattern="[0-9]*" inputmode="numeric" required oninput="this.value=this.value.replace(/[^0-9]/g,'')"></div></div></div></div></div><div class="card mb-3"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-3"><h6 class="card-subtitle mb-0">Mechanic Information</h6><button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#mecanicoModal">Add Mechanic</button></div><div class="row"><div class="col-md-6"><div class="mb-3"><label for="mecanico" class="form-label">Mechanic</label><select class="form-select select2" id="mecanico" name="mecanico" required><option value="">Select a mechanic</option>{% for mecanico in mecanicos %}<option value="{{ mecanico.id }}" data-telefono="{{ mecanico.telefono_mecanico }}">{{ mecanico.nombre_mecanico }}</option>{% endfor %}</select></div></div><div class="col-md-6"><div class="mb-3"><label for="telefonoMecanico" class="form-label">Phone</label><input type="text" class="form-control" id="telefonoMecanico" name="telefonoMecanico" inputmode="numeric" required placeholder="Enter phone number" oninput="this.value=this.value.replace(/[^0-9]/g,'');this.setCustomValidity('');"></div></div></div></div></div><div class="card mb-3"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-3"><h6 class="card-subtitle mb-0">Maintenance Information</h6><button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#tipoMantenimientoModal">Add Maintenance Type</button></div><div class="row"><div class="col-md-4"><div class="mb-3"><label for="tipoMantenimiento" class="form-label">Maintenance Type</label><select class="form-select select2" id="tipoMantenimiento" name="tipoMantenimiento" required><option value="">Select a maintenance type</option></select></div></div><div class="col-md-2"><div class="mb-3"><label for="categoria" class="form-label">Category</label><input type="text" class="form-control" id="categoria" name="categoria" readonly></div></div><div class="col-md-2"><div class="mb-3"><label for="proximoKm" class="form-label">Next (km)</label><input type="number" class="form-control" id="proximoKm" name="proximoKm" readonly></div></div><div class="col-md-2"><div class="mb-3"><label for="proximoMeses" class="form-label">Next (months)</label><input type="number" class="form-control" id="proximoMeses" name="proximoMeses" readonly></div></div><div class="col-md-2"><div class="mb-3"><label for="precio" class="form-label">Price</label><input type="number" class="form-control" id="precio" name="precio" min="0" step="any" style="-moz-appearance:textfield;-webkit-appearance:textfield;appearance:textfield" required></div></div></div></div></div><button type="submit" class="btn btn-primary btn-lg w-100">Save Maintenance</button></form></div></div></div><div class="modal fade" id="mecanicoModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Add New Mechanic</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="modalMensajeContainer" style="display:none" class="alert alert-danger mb-3"><span id="modalMensajeTexto"></span></div><form id="mecanicoForm"><div class="mb-3"><label for="nombreMecanico" class="form-label">Name</label><input type="text" class="form-control" id="nombreMecanico" name="nombreMecanico" required></div><div class="mb-3"><label for="telefonoMecanico" class="form-label">Phone</label><input type="text" class="form-control" id="telefonoMecanico" name="telefonoMecanico" inputmode="numeric" required placeholder="Enter phone number" oninput="this.value=this.value.replace(/[^0-9]/g,'');this.setCustomValidity('');"></div><button type="submit" class="btn btn-primary" name="submitMecanico">Save</button></form></div></div></div></div><div class="modal fade" id="tipoMantenimientoModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Add New Maintenance Type</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="tipoMantenimientoMensajeContainer" style="display:none" class="alert alert-danger mb-3"><span id="tipoMantenimientoMensajeTexto"></span></div><form id="tipoMantenimientoForm"><div class="mb-3"><label for="nombreTipo" class="form-label">Name</label><input type="text" class="form-control" name="nombre" id="nombreTipo" required></div><div class="mb-3"><label for="kilometros" class="form-label">Next maintenance (km)</label><div class="input-group"><input type="text" class="form-control" name="kilometros" id="kilometros" pattern="[0-9]*" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'')"><button type="button" class="btn btn-outline-primary" onclick="sugerirConIA('kilometros')">Suggest with AI</button></div></div><div class="mb-3"><label for="meses" class="form-label">Next maintenance (months)</label><div class="input-group"><input type="text" class="form-control" name="meses" id="meses" pattern="[0-9]*" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'')"><button type="button" class="btn btn-outline-primary" onclick="sugerirConIA('meses')">Suggest with AI</button></div></div><div class="mb-3"><label for="categoriaTipo" class="form-label">Category</label><div class="input-group"><select class="form-select" name="categoria" id="categoriaTipo" required><option value="">Select a category</option><option value="Motor">Engine</option><option value="Frenos">Brakes</option><option value="Transmisión">Transmission</option><option value="Suspensión">Suspension</option><option value="Eléctrico">Electrical</option><option value="Llantas">Tires</option><option value="Carrocería">Body</option><option value="Refrigeración">Cooling</option></select><button type="button" class="btn btn-outline-primary" onclick="sugerirCategoriaIA()">Select with AI</button></div></div><button type="submit" class="btn btn-primary" name="submitTipoMantenimiento">Save</button></form></div></div></div></div><script src="https://code.jquery.com/jquery-3.6.0.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script><script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script><script src="https://cdn.jsdelivr.net/npm/flatpickr"></script><script>window.sugerirConIA=function(e){const t=$("#nombreTipo").val(),n=$("#vehiculo").val();if(!n)return alert("Please select a vehicle before adding a maintenance type"),$("#vehiculo").closest(".mb-3").addClass("was-validated"),void $("#vehiculo").siblings(".select2").find(".select2-selection").css("border-color","#dc3545").attr("aria-invalid",!0);if(!t)return void alert("Please enter the maintenance type name first");const a=$(`button:contains('Add with AI')[onclick*="${e}"]`),i=a.html();a.html('<span class="spinner-border spinner-border-sm" role="status"></span> Loading...'),$.ajax({url:"/sugerir_mantenimiento",method:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({tipo_mantenimiento:t,campo:e,vehiculo_id:n}),success:function(t){if(t.success){const n=parseInt(t.sugerencia);isNaN(n)?alert("The AI returned a non-numeric value: "+t.sugerencia):$(`#${e}`).val(n).trigger("input")}else alert("Error: "+t.error)},error:function(e){alert("Error connecting to the server: "+e.statusText)},complete:function(){a.html(i)}})},window.sugerirCategoriaIA=function(){const e=$("#nombreTipo").val(),t=$("#vehiculo").val();if(!t)return alert("Please select a vehicle before selecting a category"),$("#vehiculo").closest(".mb-3").addClass("was-validated"),void $("#vehiculo").siblings(".select2").find(".select2-selection").css("border-color","#dc3545").attr("aria-invalid",!0);if(!e)return void alert("Please enter the maintenance type name first");const n=$('button:contains("Select with AI")'),a=n.html();n.html('<span class="spinner-border spinner-border-sm" role="status"></span> Loading...'),$.ajax({url:"/sugerir_categoria",method:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({tipo_mantenimiento:e,vehiculo_id:t}),success:function(e){if(e.success){const t=e.categoria,n=$("#categoriaTipo"),a=n.find(`option[value="${t}"]`);a.length>0?n.val(t).trigger("change"):n.append($("<option>",{value:t,text:t})).val(t).trigger("change")}else alert("Error: "+e.error)},error:function(e){alert("Error connecting to the server: "+e.statusText)},complete:function(){n.html(a)}})},$(document).ready((function(){flatpickr("#fecha",{locale:"en",dateFormat:"d/m/Y",maxDate:"today",allowInput:!0,enableTime:!1,appendTo:document.getElementById("fecha").parentNode});const e={vehiculo:"Please select a vehicle",fecha:"Please enter a valid date",kilometraje:"Please enter the mileage",mecanico:"Please select a mechanic",tipoMantenimiento:"Please select a maintenance type",nombreMecanico:"Please enter the mechanic name",telefonoMecanico:"Please enter a phone number",nombreTipo:"Please enter the maintenance type name",categoriaTipo:"Please select a category",precio:"Please enter the maintenance price"};function t(e,t){const n=document.getElementById(e);n&&(n.oninvalid=function(e){e.target.setCustomValidity(""),e.target.validity.valid||("object"==typeof t?e.target.validity.valueMissing?e.target.setCustomValidity(t.valueMissing):e.target.validity.patternMismatch&&e.target.setCustomValidity(t.patternMismatch):e.target.setCustomValidity(t))},n.oninput=function(e){e.target.setCustomValidity("")})}Object.keys(e).forEach((n=>t(n,e[n])));const n={mecanico:"Please select a mechanic",tipoMantenimiento:"Please select a maintenance type"};Object.keys(n).forEach((e=>{$(`#${e}`).on("select2:open",(function(){$(this).siblings(".select2").find(".select2-selection").attr("aria-invalid",!1)}))})),$("#mantenimientoForm, #mecanicoForm, #tipoMantenimientoForm").on("submit",(function(e){Object.keys(n).forEach((e=>{const t=$(`#${e}`);t.length&&!t.val()&&t.siblings(".select2").find(".select2-selection").attr("aria-invalid",!0)}))})),$("#mecanico, #tipoMantenimiento").select2({width:"100%",placeholder:"Select an option",language:{noResults:function(){return"No results found"},errorLoading:function(){return"Error loading results"},searching:function(){return"Searching..."},inputTooShort:function(){return"Please enter more characters"},inputTooLong:function(){return"Please enter less characters"},loadingMore:function(){return"Loading more results..."},maximumSelected:function(){return"Only one element can be selected"}}}),$("#vehiculo").select2({width:"100%",placeholder:$(this).data("placeholder"),allowClear:!1,language:{noResults:function(){return"No results found"},errorLoading:function(){return"Error loading results"},searching:function(){return"Searching..."},inputTooShort:function(){return"Please enter more characters"},inputTooLong:function(){return"Please enter less characters"},loadingMore:function(){return"Loading more results..."},maximumSelected:function(){return"Only one element can be selected"}}}),$("#vehiculo").on("select2:open",(function(){$("#vehiculo").siblings(".select2").find(".select2-selection").attr("aria-invalid",!1)})),$("#mantenimientoForm").on("submit",(function(e){e.preventDefault();const t=$(this).find('button[type="submit"]');if(t.prop("disabled"))return;if(t.prop("disabled",!0),!this.checkValidity())return e.stopPropagation(),$(this).addClass("was-validated"),void t.prop("disabled",!1);const n=$("#fecha").val().split("/"),a=`${n[2]}-${n[1].padStart(2,"0")}-${n[0].padStart(2,"0")}`,i={vehiculo_id:$("#vehiculo").val(),fecha:a,kilometraje:$("#kilometraje").val(),mecanico_id:$("#mecanico").val(),tipo_mantenimiento_id:$("#tipoMantenimiento").val(),precio:$("#precio").val()};$.ajax({url:"/guardar_mantenimiento",method:"POST",data:i,success:function(e){e.success?(a("¡Maintenance saved successfully!",!0),window.location.href="/mantenimientos/"+i.vehiculo_id):(a("Error: "+e.error,!1),t.prop("disabled",!1))},error:function(){a("Error connecting to the server",!1),t.prop("disabled",!1)}})})),$("#tipoMantenimientoForm").on("submit",(function(e){if(e.preventDefault(),!this.checkValidity())return e.stopPropagation(),void $(this).addClass("was-validated");const t=$("#vehiculo").val();if(!t)return a("Please select a vehicle before adding a maintenance type",!1),void $("#tipoMantenimientoModal").modal("hide");const n={nombre:$('#tipoMantenimientoForm [name="nombre"]').val(),kilometros:$('#tipoMantenimientoForm [name="kilometros"]').val(),meses:$('#tipoMantenimientoForm [name="meses"]').val(),categoria:$('#tipoMantenimientoForm [name="categoria"]').val(),vehiculo_id:t};$.ajax({url:"/agregar_tipo_mantenimiento",method:"POST",data:n,success:function(e){if(e.success){a("¡Maintenance type added successfully!",!0),$("#tipoMantenimientoModal").modal("hide"),$("#tipoMantenimientoForm")[0].reset(),$.get("/get_tipos_mantenimiento/"+t+"?nuevo_tipo_id="+e.nuevo_tipo_id,(function(t){if(t.success){const a=$("#tipoMantenimiento");a.empty().append('<option value="">Select a maintenance type</option>');const i={};t.tipos.forEach((e=>{i[e.categoria]||(i[e.categoria]=[]),i[e.categoria].push(e)})),Object.keys(i).sort().forEach((e=>{const t=$("<optgroup>").attr("label",e);i[e].forEach((e=>{t.append(new Option(e.nombre,e.id))})),a.append(t)})),a.val(t.nuevo_tipo_id).trigger("change"),$("#categoria").val(n.categoria),$("#proximoKm").val(n.kilometros||""),$("#proximoMeses").val(n.meses||"")}}));}else i(e.error)},error:function(){i("Error connecting to the server")}})})),$("#mecanicoForm").on("submit",(function(e){e.preventDefault();const t=$("#mecanicoForm #telefonoMecanico")[0],n=t.value;if(!n)return t.setCustomValidity("Please enter a phone number"),void $(this).addClass("was-validated");if(8!==n.length||!/^\d+$/.test(n))return t.setCustomValidity("The phone number must have exactly 8 digits"),void $(this).addClass("was-validated");if(!this.checkValidity())return e.stopPropagation(),void $(this).addClass("was-validated");const i={nombre:$("#nombreMecanico").val(),telefono:$("#mecanicoForm #telefonoMecanico").val()};$.ajax({url:"/agregar_mecanico",method:"POST",data:i,success:function(e){if(e.success){a("¡Mechanic added successfully!",!0);const t=$("#mecanico"),n=new Option(e.mecanico.nombre,e.mecanico.id,!0,!0);$(n).data("telefono",e.mecanico.telefono),t.append(n).trigger("change"),$("#telefonoMecanico").val(e.mecanico.telefono),$("#mecanicoModal").modal("hide"),$("#mecanicoForm")[0].reset()}else{const t=e.error.includes("Ya existe un mecánico")?e.error:"Error adding mechanic: "+e.error;n(t)}},error:function(){n("Error connecting to the server")}})})),$("#kilometraje").on("keypress",(function(e){e.which<48||e.which>57&&e.preventDefault()})),$("#kilometraje").on("paste",(function(e){e.preventDefault();const t=(e.originalEvent.clipboardData||window.clipboardData).getData("text").replace(/[^0-9]/g,"");$(this).val(t)})),$("#mecanicoForm #telefonoMecanico").on("keypress",(function(e){(e.which<48||e.which>57)&&e.preventDefault(),this.value.length>=8&&e.preventDefault()})),$("#mecanicoForm #telefonoMecanico").on("paste",(function(e){e.preventDefault();const t=(e.originalEvent.clipboardData||window.clipboardData).getData("text").replace(/[^0-9]/g,"").substring(0,8);$(this).val(t)})),$("#kilometros, #meses").on("keypress",(function(e){e.which<48||e.which>57&&e.preventDefault()})),$("#kilometros, #meses").on("paste",(function(e){e.preventDefault();const t=(e.originalEvent.clipboardData||window.clipboardData).getData("text").replace(/[^0-9]/g,"");$(this).val(t)})),$("#mecanico").on("change",(function(){const e=$(this).find(":selected").data("telefono")||"";$("#telefonoMecanico").val(e)})),$("#vehiculo").on("change",(function(){const e=$(this).val(),t=$("#tipoMantenimiento");if(t.empty().append('<option value="">Select a maintenance type</option>').prop("disabled",!0),e){$.get("/get_tipos_mantenimiento/"+e,(function(e){if(e.success){const n={};e.tipos.forEach((e=>{n[e.categoria]||(n[e.categoria]=[]),n[e.categoria].push(e)})),Object.keys(n).sort().forEach((e=>{const a=$("<optgroup>").attr("label",e);n[e].forEach((e=>{a.append(new Option(e.nombre,e.id))})),t.append(a)})),t.prop("disabled",!1)}}));}t.trigger("change")})),$("#tipoMantenimiento").on("change",(function(){const e=$(this).val();e?$.get("/get_tipo_mantenimiento/"+e,(function(e){e.success&&($("#categoria").val(e.tipo.categoria),$("#proximoKm").val(e.tipo.kilometros_proximo_mantenimiento),$("#proximoMeses").val(e.tipo.meses_proximo_mantenimiento))})):($("#categoria").val(""),$("#proximoKm").val(""),$("#proximoMeses").val(""))}));function a(e,t){const n=$("#mensajeContainer"),a=$("#mensajeTexto");n.removeClass("alert-success alert-danger").addClass(t?"alert-success":"alert-danger"),a.text(e),n.show(),setTimeout((()=>{n.fadeOut()}),5e3)}function n(e){const t=$("#modalMensajeContainer"),n=$("#modalMensajeTexto");n.text(e),t.show()}function i(e){const t=$("#tipoMantenimientoMensajeContainer"),n=$("#tipoMantenimientoMensajeTexto");n.text(e),t.show()}$("#mecanicoModal").on("show.bs.modal",(function(){$("#modalMensajeContainer").hide()})),$("#tipoMantenimientoModal").on("show.bs.modal",(function(){$("#tipoMantenimientoMensajeContainer").hide()})),$("#precio").on("keypress",(function(e){e.which<48||e.which>57&&46!==e.which&&e.preventDefault(),46===e.which&&-1!==$(this).val().indexOf(".")&&e.preventDefault()})),$("#precio").on("paste",(function(e){e.preventDefault();const t=(e.originalEvent.clipboardData||window.clipboardData).getData("text").replace(/[^0-9.]/g,"").replace(/(\..*)\./g,"$1");$(this).val(t)}))}));</script></body></html>