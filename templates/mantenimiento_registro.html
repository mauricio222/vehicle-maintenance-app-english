<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Registration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <style>
        /* Default modal z-index for proper stacking */
        #mecanicoModal {
            z-index: 1050;
        }

        #tipoMantenimientoModal {
            z-index: 1050;
        }

        /* Ensure AI Explanation modal appears on top */
        #aiExplanationModal {
            z-index: 1060 !important;
        }

        /* Delay consequences modal should be on top of everything */
        #delayConsequencesModal {
            z-index: 1070 !important;
        }

        /* Fix modal backdrop issues */
        .modal-backdrop {
            z-index: 1040;
        }

        .modal-backdrop.show {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Maintenance Registration</h1>
            <div>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back</a>
                {% if g.user %}
                    <a href="{{ url_for('logout') }}" class="btn btn-danger ms-2">Logout ({{ g.user.username }})</a>
                {% endif %}
            </div>
        </div>

        <!-- Contenedor de mensajes -->
        <div id="mensajeContainer" style="display: none;" class="alert alert-dismissible fade show mb-3" role="alert">
            <span id="mensajeTexto"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Formulario principal -->
        <div class="card">
            <div class="card-body">
                <form id="mantenimientoForm">
                    <!-- Bloque 1: Veh√≠culo, Fecha y Mileage -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-3">Vehicle Information</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="vehiculo" class="form-label">Vehicle</label>
                                        <select class="form-select" id="vehiculo" name="vehiculo" required data-placeholder="Select a vehicle">
                                            <option></option>
                                            {% for vehiculo in vehiculos %}
                                            <option value="{{ vehiculo.id }}">
                                                {{ vehiculo.alias }} - {{ vehiculo.marca }} {{ vehiculo.modelo }} ({{ vehiculo.anio }})
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="fecha" class="form-label">Date</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="fecha"
                                                   name="fecha" placeholder="mm/dd/yyyy" required>
                                            <button class="btn btn-outline-secondary" type="button" id="fechaBtn">
                                                üìÖ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="mileage" class="form-label">Mileage</label>
                                        <input type="text" class="form-control" id="mileage"
                                               name="mileage"
                                               pattern="[0-9]*" inputmode="numeric" required
                                               oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bloque 2: Mec√°nico -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="card-subtitle mb-0">Mechanic Information</h6>
                                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#mecanicoModal">
                                    Add Mechanic
                                </button>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="mecanico" class="form-label">Mechanic</label>
                                        <select class="form-select select2" id="mecanico" name="mecanico" required>
                                            <option value="">Select a mechanic</option>
                                            {% for mecanico in mecanicos %}
                                            <option value="{{ mecanico.id }}" data-telefono="{{ mecanico.telefono_mecanico }}">
                                                {{ mecanico.nombre_mecanico }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="telefonoMecanico" class="form-label">Phone</label>
                                        <input type="text" class="form-control" id="telefonoMecanico"
                                               name="telefonoMecanico"
                                               inputmode="numeric" required
                                               placeholder="Enter phone number"
                                               oninput="this.value = this.value.replace(/[^0-9]/g, ''); this.setCustomValidity('');">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bloque 3: Tipo de Mantenimiento -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="card-subtitle mb-0">Maintenance Information</h6>
                                <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#tipoMantenimientoModal">
                                    Add Maintenance Type
                                </button>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="tipoMantenimiento" class="form-label">Maintenance Type</label>
                                        <select class="form-select select2" id="tipoMantenimiento" name="tipoMantenimiento" required>
                                            <option value="">Select a maintenance type</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="categoria" class="form-label">Category</label>
                                        <input type="text" class="form-control" id="categoria" name="categoria" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="proximo_mileage" class="form-label">Next (mi)</label>
                                        <input type="number" class="form-control" id="proximo_mileage" name="proximo_mileage" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="proximoMeses" class="form-label">Next (months)</label>
                                        <input type="number" class="form-control" id="proximoMeses" name="proximoMeses" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="precio" class="form-label">Price</label>
                                        <input type="number" class="form-control" id="precio" name="precio" min="0" step="any"
                                               style="-moz-appearance: textfield; -webkit-appearance: textfield; appearance: textfield;" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100">Save Maintenance</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Mec√°nico -->
    <div class="modal fade" id="mecanicoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Mechanic</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Contenedor de mensajes del modal -->
                    <div id="modalMensajeContainer" style="display: none;" class="alert alert-danger mb-3">
                        <span id="modalMensajeTexto"></span>
                    </div>
                    <form id="mecanicoForm">
                        <div class="mb-3">
                            <label for="nombreMecanico" class="form-label">Name</label>
                            <input type="text" class="form-control" id="nombreMecanico" name="nombreMecanico" required>
                        </div>
                        <div class="mb-3">
                            <label for="telefonoMecanico" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="telefonoMecanico"
                                   name="telefonoMecanico"
                                   inputmode="numeric" required
                                   placeholder="Enter phone number"
                                   oninput="this.value = this.value.replace(/[^0-9]/g, ''); this.setCustomValidity('');">
                        </div>
                        <button type="submit" class="btn btn-primary" name="submitMecanico">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Explanation Modal -->
    <div class="modal fade" id="aiExplanationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="aiExplanationTitle">AI Suggestion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-robot"></i>
                        <p id="aiExplanationText" class="mt-2 mb-0"></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tipo de Mantenimiento -->
    <div class="modal fade" id="tipoMantenimientoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Maintenance Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Contenedor de mensajes del modal -->
                    <div id="tipoMantenimientoMensajeContainer" style="display: none;" class="alert alert-danger mb-3">
                        <span id="tipoMantenimientoMensajeTexto"></span>
                    </div>
                    <form id="tipoMantenimientoForm">
                        <div class="mb-3">
                            <label for="nombreTipo" class="form-label">Name</label>
                            <input type="text" class="form-control" name="nombre" id="nombreTipo" required>
                        </div>
                        <div class="mb-3">
                            <label for="miles" class="form-label">Next maintenance (mi)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="miles" id="miles"
                                       pattern="[0-9]*" inputmode="numeric"
                                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                <button type="button" class="btn btn-outline-primary" onclick="sugerirConIA('miles')">
                                    Suggest with AI
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="meses" class="form-label">Next maintenance (months)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="meses" id="meses"
                                       pattern="[0-9]*" inputmode="numeric"
                                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                <button type="button" class="btn btn-outline-primary" onclick="sugerirConIA('meses')">
                                    Suggest with AI
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="categoriaTipo" class="form-label">Category</label>
                            <div class="input-group">
                                <select class="form-select" name="categoria" id="categoriaTipo" required>
                                    <option value="">Select a category</option>
                                    <option value="Motor">Engine</option>
                                    <option value="Frenos">Brakes</option>
                                    <option value="Transmisi√≥n">Transmission</option>
                                    <option value="Suspensi√≥n">Suspension</option>
                                    <option value="El√©ctrico">Electrical</option>
                                    <option value="Llantas">Tires</option>
                                    <option value="Carrocer√≠a">Body</option>
                                    <option value="Refrigeraci√≥n">Cooling</option>
                                </select>
                                <button type="button" class="btn btn-outline-primary" onclick="sugerirCategoriaIA()">
                                    Select with AI
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" name="submitTipoMantenimiento">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delay Consequences Modal -->
    <div class="modal fade" id="delayConsequencesModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="delayConsequencesTitle">
                        <i class="bi bi-exclamation-triangle-fill"></i> What happens if I delay Oil change?
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="vehicleWarning" class="alert alert-info mb-3" style="display: none;">
                        <i class="bi bi-info-circle-fill"></i> <strong>Note:</strong> A vehicle has been automatically selected for you. You can change it if needed.
                    </div>
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">‚ö†Ô∏è Warning: Delaying Oil Changes</h6>
                        <p class="mt-3">
                            <strong>Oil changes are essential for engine lubrication and preventing wear.</strong>
                        </p>
                        <p>
                            In tropical climates, the oil breaks down faster due to heat, requiring more frequent changes.
                            Delaying oil changes can lead to:
                        </p>
                        <ul>
                            <li>üîß Increased engine wear and tear</li>
                            <li>üå°Ô∏è Engine overheating</li>
                            <li>‚öôÔ∏è Reduced fuel efficiency</li>
                            <li>üí∞ Costly engine repairs or replacement</li>
                            <li>üöó Complete engine failure in severe cases</li>
                        </ul>
                        <p class="mb-0 mt-3">
                            <strong>Recommendation:</strong> Follow your vehicle manufacturer's oil change schedule,
                            typically every 3,000-5,000 miles or 3-6 months, whichever comes first.
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" id="openMaintenanceTypeModal">
                        Add Oil Change Maintenance
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        // Function to show AI explanation modal on top of the maintenance type modal
        window.showAIExplanation = function(question, explanation) {
            $('#aiExplanationTitle').text(question);
            $('#aiExplanationText').text(explanation);

            // Set higher z-index for the AI modal to appear on top
            $('#aiExplanationModal').css('z-index', 1060);

            // Show the modal with backdrop: 'static' to prevent closing when clicking outside
            const modal = new bootstrap.Modal(document.getElementById('aiExplanationModal'), {
                backdrop: 'static',
                keyboard: true
            });
            modal.show();

            // Ensure the backdrop for AI modal has higher z-index
            $('#aiExplanationModal').on('shown.bs.modal', function () {
                $('.modal-backdrop').last().css('z-index', 1055);
            });
        };

        // Move the function outside the document ready handler
        window.sugerirConIA = function(tipo) {
            // When adding a new maintenance type, get the name from the input field
            // not from the selected dropdown (since we're creating a new type)
            const nombreTipo = $('#nombreTipo').val();
            const vehiculoId = $('#vehiculo').val();

            if (!vehiculoId) {
                alert('Please select a vehicle before adding a maintenance type');
                $('#vehiculo').closest('.mb-3').addClass('was-validated');
                $('#vehiculo').siblings('.select2').find('.select2-selection')
                              .css('border-color', '#dc3545')
                              .attr('aria-invalid', true);
                return;
            }

            if (!nombreTipo || nombreTipo.trim() === '') {
                alert('Please enter a maintenance type name first');
                $('#nombreTipo').focus();
                return;
            }

            const button = $(`button:contains('Suggest with AI')[onclick*="${tipo}"]`);
            const originalText = button.html();
            button.html('<span class="spinner-border spinner-border-sm" role="status"></span> Loading...');

            $.ajax({
                url: '/suggest_maintenance',
                method: 'POST',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify({
                    tipo_mantenimiento: nombreTipo,
                    campo: tipo,
                    vehiculo_id: vehiculoId
                }),
                success: function(response) {
                    if (response.success) {
                        if (response.sugerencia === 'N/A') {
                            // Handle N/A response - maintenance not applicable
                            alert('‚ö†Ô∏è Not Applicable: ' + (response.message || 'This maintenance type does not apply to this vehicle configuration'));
                            $(`#${tipo}`).val('N/A').trigger('input');
                        } else {
                            const valor = parseInt(response.sugerencia);
                            if (!isNaN(valor)) {
                                $(`#${tipo}`).val(valor).trigger('input');

                                // Show explanation modal if available
                                if (response.explanation) {
                                    showAIExplanation(response.question || 'AI Suggestion', response.explanation);
                                }
                            } else {
                                alert('The AI returned a non-numeric value: ' + response.sugerencia);
                            }
                        }
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function(xhr) {
                    alert('Error connecting to the server: ' + xhr.statusText);
                },
                complete: function() {
                    button.html(originalText);
                }
            });
        };

        window.sugerirCategoriaIA = function() {
            // When adding a new maintenance type, get the name from the input field
            // not from the selected dropdown (since we're creating a new type)
            const nombreTipo = $('#nombreTipo').val();
            const vehiculoId = $('#vehiculo').val();

            if (!vehiculoId) {
                alert('Please select a vehicle before selecting a category');
                $('#vehiculo').closest('.mb-3').addClass('was-validated');
                $('#vehiculo').siblings('.select2').find('.select2-selection')
                              .css('border-color', '#dc3545')
                              .attr('aria-invalid', true);
                return;
            }

            if (!nombreTipo || nombreTipo.trim() === '') {
                alert('Please enter a maintenance type name first');
                $('#nombreTipo').focus();
                return;
            }

            const button = $('button:contains("Select with AI")');
            const originalText = button.html();
            button.html('<span class="spinner-border spinner-border-sm" role="status"></span> Loading...');

            $.ajax({
                url: '/suggest_category',
                method: 'POST',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify({
                    tipo_mantenimiento: nombreTipo,
                    vehiculo_id: vehiculoId
                }),
                success: function(response) {
                    if (response.success) {
                        if (response.categoria === 'N/A') {
                            // Handle N/A response - maintenance not applicable
                            alert('‚ö†Ô∏è Not Applicable: ' + (response.message || 'This maintenance type does not apply to this vehicle configuration'));
                            $('#categoriaTipo').val('').trigger('change');
                        } else {
                            const categoria = response.categoria;
                            const select = $('#categoriaTipo');

                            // Buscar opci√≥n existente
                            const option = select.find(`option[value="${categoria}"]`);
                            if (option.length > 0) {
                                select.val(categoria).trigger('change');
                            } else {
                                // Agregar nueva opci√≥n si no existe
                                select.append($('<option>', {
                                    value: categoria,
                                    text: categoria
                                })).val(categoria).trigger('change');
                            }
                        }
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function(xhr) {
                    alert('Error connecting to the server: ' + xhr.statusText);
                },
                complete: function() {
                    button.html(originalText);
                }
            });
        };

        $(document).ready(function() {
            // Check URL parameters for showing delay consequences modal
            const urlParams = new URLSearchParams(window.location.search);
            const showDelayModal = urlParams.get('show_delay_modal');
            const maintenanceType = urlParams.get('type');

            if (showDelayModal === 'true' && maintenanceType === 'oil_change') {
                let vehicleAutoSelected = false;

                // First, auto-select the first vehicle if none is selected
                if (!$('#vehiculo').val()) {
                    const firstVehicleOption = $('#vehiculo option:not(:first)').first();
                    if (firstVehicleOption.length > 0) {
                        $('#vehiculo').val(firstVehicleOption.val()).trigger('change');
                        vehicleAutoSelected = true;
                    }
                }

                // Wait for vehicle selection to process, then show modals
                setTimeout(function() {
                    // First show the maintenance type modal
                    $('#tipoMantenimientoModal').modal('show');

                    // Set oil change in the maintenance type field
                    $('#nombreTipo').val('Oil change');

                    // Then show the delay consequences modal on top after a short delay
                    setTimeout(function() {
                        // Show vehicle warning if auto-selected
                        if (vehicleAutoSelected) {
                            $('#vehicleWarning').show();
                        }
                        $('#delayConsequencesModal').modal('show');
                    }, 500);
                }, 1000); // Give more time for vehicle selection to load maintenance types
            }

            // Handle the "Add Oil Change Maintenance" button in delay modal
            $('#openMaintenanceTypeModal').on('click', function() {
                // Close the delay consequences modal
                $('#delayConsequencesModal').modal('hide');

                // Make sure the maintenance type modal stays open
                // and oil change is pre-filled
                $('#nombreTipo').val('Oil change');

                // If no vehicle is selected, select the first one
                if (!$('#vehiculo').val()) {
                    const firstVehicleOption = $('#vehiculo option:not(:first)').first();
                    if (firstVehicleOption.length > 0) {
                        $('#vehiculo').val(firstVehicleOption.val()).trigger('change');
                    }
                }
            });

            // Inicializar Flatpickr para el campo de fecha
            const fp = flatpickr("#fecha", {
                dateFormat: "m/d/Y",  // US format: mm/dd/yyyy
                altFormat: "m/d/Y",
                maxDate: "today",
                allowInput: true,
                enableTime: false,
                defaultDate: "today",
                disableMobile: false,
                static: true,
                monthSelectorType: "dropdown",
                yearSelectorType: "dropdown",
                onReady: function(dateObj, dateStr, instance) {
                    // Ensure the input has proper attributes for better mobile support
                    const input = instance.input;
                    input.removeAttribute('readonly'); // Allow typing
                    input.style.backgroundColor = 'white';
                    input.style.cursor = 'pointer';

                    // Add click event to open calendar
                    input.addEventListener('click', function() {
                        instance.open();
                    });

                    // Add button click handler
                    const btn = document.getElementById('fechaBtn');
                    btn.addEventListener('click', function() {
                        instance.open();
                    });
                },
                clickOpens: true,
                appendTo: document.body,
                position: "auto"
            });

            // Personalizar mensajes de validaci√≥n para todos los campos requeridos
            const campos = {
                'vehiculo': 'Please select a vehicle',
                'fecha': 'Please enter a valid date',
                'mileage': 'Please enter the mileage',
                'mecanico': 'Please select a mechanic',
                'tipoMantenimiento': 'Please select a maintenance type',
                'nombreMecanico': 'Please enter the mechanic name',
                'telefonoMecanico': 'Please enter a phone number',
                'nombreTipo': 'Please enter the maintenance type name',
                'categoriaTipo': 'Please select a category',
                'precio': 'Please enter the maintenance price'
            };

            // Funci√≥n para configurar mensajes de validaci√≥n personalizados
            function configurarValidacion(elementId, mensaje) {
                const elemento = document.getElementById(elementId);
                if (elemento) {
                    elemento.oninvalid = function(e) {
                        e.target.setCustomValidity('');
                        if (!e.target.validity.valid) {
                            if (typeof mensaje === 'object') {
                                // Si hay diferentes mensajes para diferentes tipos de error
                                if (e.target.validity.valueMissing) {
                                    e.target.setCustomValidity(mensaje.valueMissing);
                                } else if (e.target.validity.patternMismatch) {
                                    e.target.setCustomValidity(mensaje.patternMismatch);
                                }
                            } else {
                                e.target.setCustomValidity(mensaje);
                            }
                        }
                    };
                    elemento.oninput = function(e) {
                        e.target.setCustomValidity('');
                    };
                }
            }

            // Configurar mensajes para cada campo
            Object.keys(campos).forEach(id => configurarValidacion(id, campos[id]));

            // Configurar Select2 para mostrar mensajes en espa√±ol
            const select2Mensajes = {
                'mecanico': 'Please select a mechanic',
                'tipoMantenimiento': 'Please select a maintenance type'
            };

            Object.keys(select2Mensajes).forEach(id => {
                $(`#${id}`).on('select2:open', function() {
                    $(this).siblings('.select2').find('.select2-selection').attr('aria-invalid', false);
                });
            });

            $('#mantenimientoForm, #mecanicoForm, #tipoMantenimientoForm').on('submit', function(e) {
                Object.keys(select2Mensajes).forEach(id => {
                    const elemento = $(`#${id}`);
                    if (elemento.length && !elemento.val()) {
                        elemento.siblings('.select2').find('.select2-selection').attr('aria-invalid', true);
                    }
                });
            });

            // Inicializar Select2 para mec√°nico y tipo de mantenimiento
            $('#mecanico, #tipoMantenimiento').select2({
                width: '100%',
                placeholder: 'Select an option',
                language: {
                    noResults: function() {
                        return "No results found";
                    },
                    errorLoading: function() {
                        return "Error loading results";
                    },
                    searching: function() {
                        return "Searching...";
                    },
                    inputTooShort: function() {
                        return "Please enter more characters";
                    },
                    inputTooLong: function() {
                        return "Please enter less characters";
                    },
                    loadingMore: function() {
                        return "Loading more results...";
                    },
                    maximumSelected: function() {
                        return "Only one element can be selected";
                    }
                }
            });

            // Inicializar Select2 para veh√≠culo con configuraci√≥n espec√≠fica
            $('#vehiculo').select2({
                width: '100%',
                placeholder: $(this).data('placeholder'),
                allowClear: false,
                language: {
                    noResults: function() {
                        return "No results found";
                    },
                    errorLoading: function() {
                        return "Error loading results";
                    },
                    searching: function() {
                        return "Searching...";
                    },
                    inputTooShort: function() {
                        return "Please enter more characters";
                    },
                    inputTooLong: function() {
                        return "Please enter less characters";
                    },
                    loadingMore: function() {
                        return "Loading more results...";
                    },
                    maximumSelected: function() {
                        return "Only one element can be selected";
                    }
                }
            });

            // Personalizar mensaje de validaci√≥n para el campo veh√≠culo
            $('#vehiculo').on('select2:open', function() {
                $('#vehiculo').siblings('.select2').find('.select2-selection').attr('aria-invalid', false);
            });

            $('#mantenimientoForm').on('submit', function(e) {
                e.preventDefault();

                // Prevenir m√∫ltiples env√≠os
                const submitButton = $(this).find('button[type="submit"]');
                if (submitButton.prop('disabled')) {
                    return;
                }
                submitButton.prop('disabled', true);

                if (!this.checkValidity()) {
                    e.stopPropagation();
                    $(this).addClass('was-validated');
                    submitButton.prop('disabled', false);
                    return;
                }

                // Convertir fecha de mm/dd/yyyy a yyyy-mm-dd para el backend
                const fecha = $('#fecha').val();
                const fechaPartes = fecha.split('/');
                const fechaISO = `${fechaPartes[2]}-${fechaPartes[0].padStart(2, '0')}-${fechaPartes[1].padStart(2, '0')}`;

                // Recolectar datos del formulario
                const formData = {
                    vehiculo_id: $('#vehiculo').val(),
                    fecha: fechaISO,
                    mileage: $('#mileage').val(),
                    mecanico_id: $('#mecanico').val(),
                    tipo_mantenimiento_id: $('#tipoMantenimiento').val(),
                    precio: $('#precio').val()
                };

                // Enviar datos al servidor
                $.ajax({
                    url: '/save_maintenance',
                    method: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            // Mostrar mensaje de √©xito
                            mostrarMensaje('¬°Maintenance saved successfully!', true);

                            // Redirect to the vehicle maintenance page
                            window.location.href = '/maintenance/' + formData.vehiculo_id;
                        } else {
                            // Mostrar mensaje de error
                            mostrarMensaje('Error: ' + response.error, false);
                        }
                        // Reactivar el bot√≥n despu√©s de la respuesta
                        submitButton.prop('disabled', false);
                    },
                    error: function() {
                        mostrarMensaje('Error connecting to the server', false);
                        // Reactivar el bot√≥n en caso de error
                        submitButton.prop('disabled', false);
                    }
                });
            });

            // Handle opening of maintenance type modal - show warning if no vehicle
            $('#tipoMantenimientoModal').on('show.bs.modal', function(e) {
                const vehiculoId = $('#vehiculo').val();
                if (!vehiculoId) {
                    // Show warning in the modal instead of preventing it from opening
                    $('#tipoMantenimientoMensajeContainer').removeClass('alert-danger').addClass('alert-warning');
                    $('#tipoMantenimientoMensajeTexto').text('‚ö†Ô∏è Please select a vehicle first. AI suggestions will only work after selecting a vehicle.');
                    $('#tipoMantenimientoMensajeContainer').show();
                } else {
                    $('#tipoMantenimientoMensajeContainer').hide();
                }
            });

            // Handle opening of mechanic modal - always allow
            $('#mecanicoModal').on('show.bs.modal', function(e) {
                // Mechanic can be added without selecting a vehicle
                // Clear any previous messages
                $('#modalMensajeContainer').hide();
            });

            // Manejar el env√≠o del formulario de tipo de mantenimiento
            $('#tipoMantenimientoForm').on('submit', function(e) {
                e.preventDefault();

                if (!this.checkValidity()) {
                    e.stopPropagation();
                    $(this).addClass('was-validated');
                    return;
                }

                // Obtener el detalle_id del veh√≠culo seleccionado
                const vehiculoId = $('#vehiculo').val();
                if (!vehiculoId) {
                    mostrarMensaje('Please select a vehicle before adding a maintenance type', false);
                    $('#tipoMantenimientoModal').modal('hide');
                    return;
                }

                // Recolectar datos del formulario
                const formData = {
                    nombre: $('#tipoMantenimientoForm [name="nombre"]').val(),
                    miles: $('#tipoMantenimientoForm [name="miles"]').val(),
                    meses: $('#tipoMantenimientoForm [name="meses"]').val(),
                    categoria: $('#tipoMantenimientoForm [name="categoria"]').val(),
                    vehiculo_id: vehiculoId
                };

                // Enviar datos al servidor
                $.ajax({
                    url: '/add_maintenance_type',
                    method: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            // Mostrar mensaje de √©xito
                            mostrarMensaje('¬°Maintenance type added successfully!', true);

                            // Cerrar modal y limpiar formulario
                            $('#tipoMantenimientoModal').modal('hide');
                            $('#tipoMantenimientoForm')[0].reset();

                            // Actualizar lista de tipos de mantenimiento y seleccionar el nuevo
                            $.get('/get_maintenance_types/' + vehiculoId + '?nuevo_tipo_id=' + response.nuevo_tipo_id, function(response) {
                                if (response.success) {
                                    // Actualizar el select de tipos de mantenimiento
                                    const tipoSelect = $('#tipoMantenimiento');
                                    tipoSelect.empty().append('<option value="">Select a maintenance type</option>');

                                    // Agrupar por categor√≠a
                                    const tiposPorCategoria = {};
                                    response.tipos.forEach(tipo => {
                                        if (!tiposPorCategoria[tipo.categoria]) {
                                            tiposPorCategoria[tipo.categoria] = [];
                                        }
                                        tiposPorCategoria[tipo.categoria].push(tipo);
                                    });

                                    // Crear optgroups por categor√≠a
                                    Object.keys(tiposPorCategoria).sort().forEach(categoria => {
                                        const optgroup = $('<optgroup>').attr('label', categoria);
                                        tiposPorCategoria[categoria].forEach(tipo => {
                                            optgroup.append(new Option(tipo.nombre, tipo.id));
                                        });
                                        tipoSelect.append(optgroup);
                                    });

                                    // Seleccionar el nuevo tipo de mantenimiento
                                    tipoSelect.val(response.nuevo_tipo_id).trigger('change');

                                    // Note: The fields will be auto-populated by the change event above
                                    // which calls /get_maintenance_type/ endpoint
                                }
                            });
                        } else {
                            // Mostrar mensaje de error en el modal
                            mostrarMensajeTipoMantenimiento(response.error);
                        }
                    },
                    error: function() {
                        mostrarMensajeTipoMantenimiento('Error connecting to the server');
                    }
                });
            });

            // Manejar el env√≠o del formulario de mec√°nico
            $('#mecanicoForm').on('submit', function(e) {
                e.preventDefault();

                const telefonoInput = $('#mecanicoForm #telefonoMecanico')[0];
                const telefono = telefonoInput.value;

                // Validar el tel√©fono
                if (!telefono) {
                    telefonoInput.setCustomValidity('Please enter a phone number');
                    $(this).addClass('was-validated');
                    return;
                } else if (telefono.length !== 8 || !/^\d+$/.test(telefono)) {
                    telefonoInput.setCustomValidity('The phone number must have exactly 8 digits');
                    $(this).addClass('was-validated');
                    return;
                }

                if (!this.checkValidity()) {
                    e.stopPropagation();
                    $(this).addClass('was-validated');
                    return;
                }

                // Recolectar datos del formulario
                const formData = {
                    nombre: $('#nombreMecanico').val(),
                    telefono: $('#mecanicoForm #telefonoMecanico').val()
                };

                // Enviar datos al servidor
                $.ajax({
                    url: '/add_mechanic',
                    method: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            // Mostrar mensaje de √©xito en la p√°gina principal
                            mostrarMensaje('¬°Mechanic added successfully!', true);

                            // Agregar el nuevo mec√°nico al select
                            const mecanicoSelect = $('#mecanico');
                            const nuevaOpcion = new Option(
                                response.mecanico.nombre,
                                response.mecanico.id,
                                true,
                                true
                            );
                            $(nuevaOpcion).data('telefono', response.mecanico.telefono);
                            mecanicoSelect.append(nuevaOpcion).trigger('change');

                            // Auto-popular el tel√©fono
                            $('#telefonoMecanico').val(response.mecanico.telefono);

                            // Cerrar modal y limpiar formulario
                            $('#mecanicoModal').modal('hide');
                            $('#mecanicoForm')[0].reset();
                        } else {
                            // Mostrar mensaje de error en el modal
                            const mensaje = response.error.includes('Ya existe un mec√°nico')
                                ? response.error
                                : 'Error adding mechanic: ' + response.error;
                            mostrarMensajeModal(mensaje);
                        }
                    },
                    error: function() {
                        mostrarMensajeModal('Error connecting to the server');
                    }
                });
            });

            // Validar entrada de mileage
            $('#mileage').on('keypress', function(e) {
                // Permitir solo n√∫meros (c√≥digos de tecla 48-57)
                if (e.which < 48 || e.which > 57) {
                    e.preventDefault();
                }
            });

            // Limpiar cualquier car√°cter no num√©rico en caso de pegar texto
            $('#mileage').on('paste', function(e) {
                e.preventDefault();
                const text = (e.originalEvent.clipboardData || window.clipboardData).getData('text');
                const numbers = text.replace(/[^0-9]/g, '');
                $(this).val(numbers);
            });

            // Validar entrada de tel√©fono del mec√°nico
            $('#mecanicoForm #telefonoMecanico').on('keypress', function(e) {
                // Permitir solo n√∫meros (c√≥digos de tecla 48-57)
                if (e.which < 48 || e.which > 57) {
                    e.preventDefault();
                }
                // Limitar a 8 d√≠gitos
                if (this.value.length >= 8) {
                    e.preventDefault();
                }
            });

            // Limpiar cualquier car√°cter no num√©rico en caso de pegar texto
            $('#mecanicoForm #telefonoMecanico').on('paste', function(e) {
                e.preventDefault();
                const text = (e.originalEvent.clipboardData || window.clipboardData).getData('text');
                const numbers = text.replace(/[^0-9]/g, '').substring(0, 8);
                $(this).val(numbers);
            });

            // Validar entrada de miles y meses
            $('#miles, #meses').on('keypress', function(e) {
                // Permitir solo n√∫meros (c√≥digos de tecla 48-57)
                if (e.which < 48 || e.which > 57) {
                    e.preventDefault();
                }
            });

            // Limpiar cualquier car√°cter no num√©rico en caso de pegar texto
            $('#miles, #meses').on('paste', function(e) {
                e.preventDefault();
                const text = (e.originalEvent.clipboardData || window.clipboardData).getData('text');
                const numbers = text.replace(/[^0-9]/g, '');
                $(this).val(numbers);
            });

            // Auto-poblar tel√©fono del mec√°nico
            $('#mecanico').on('change', function() {
                const telefono = $(this).find(':selected').data('telefono') || '';
                $('#telefonoMecanico').val(telefono);
            });

            // Actualizar tipos de mantenimiento al seleccionar veh√≠culo
            $('#vehiculo').on('change', function() {
                const vehiculoId = $(this).val();
                const tipoSelect = $('#tipoMantenimiento');

                // Limpiar y deshabilitar el select de tipos
                tipoSelect.empty().append('<option value="">Select a maintenance type</option>').prop('disabled', true);

                if (vehiculoId) {
                    // Obtener tipos de mantenimiento para el veh√≠culo seleccionado
                    $.get('/get_maintenance_types/' + vehiculoId, function(response) {
                        if (response.success) {
                            // Agrupar por categor√≠a
                            const tiposPorCategoria = {};
                            response.tipos.forEach(tipo => {
                                if (!tiposPorCategoria[tipo.categoria]) {
                                    tiposPorCategoria[tipo.categoria] = [];
                                }
                                tiposPorCategoria[tipo.categoria].push(tipo);
                            });

                            // Crear optgroups por categor√≠a
                            Object.keys(tiposPorCategoria).sort().forEach(categoria => {
                                const optgroup = $('<optgroup>').attr('label', categoria);
                                tiposPorCategoria[categoria].forEach(tipo => {
                                    optgroup.append(new Option(tipo.nombre, tipo.id));
                                });
                                tipoSelect.append(optgroup);
                            });

                            // Habilitar el select
                            tipoSelect.prop('disabled', false);
                        }
                    });
                }

                // Actualizar Select2
                tipoSelect.trigger('change');
            });

            // Auto-poblar informaci√≥n del tipo de mantenimiento
            $('#tipoMantenimiento').on('change', function() {
                const tipoId = $(this).val();
                if (tipoId) {
                    $.get('/get_maintenance_type/' + tipoId, function(response) {
                        console.log('Maintenance type response:', response);
                        if (response.success) {
                            console.log('Setting categoria:', response.tipo.categoria);
                            console.log('Setting miles:', response.tipo.miles_next_maintenance);
                            console.log('Setting meses:', response.tipo.meses_proximo_mantenimiento);

                            $('#categoria').val(response.tipo.categoria);

                            // For number inputs with readonly, we need to set the value differently
                            var milesValue = response.tipo.miles_next_maintenance || '';
                            var mesesValue = response.tipo.meses_proximo_mantenimiento || '';

                            console.log('Attempting to set miles to:', milesValue);
                            console.log('Attempting to set meses to:', mesesValue);

                            // Method 1: Remove readonly, set value, restore readonly
                            $('#proximo_mileage').prop('readonly', false);
                            $('#proximo_mileage').val(milesValue);
                            $('#proximo_mileage').prop('readonly', true);

                            // Method 2: Also use attr and prop to ensure it's set
                            $('#proximo_mileage').attr('value', milesValue);
                            document.getElementById('proximo_mileage').value = milesValue;

                            // Same for months
                            $('#proximoMeses').prop('readonly', false);
                            $('#proximoMeses').val(mesesValue);
                            $('#proximoMeses').prop('readonly', true);

                            $('#proximoMeses').attr('value', mesesValue);
                            document.getElementById('proximoMeses').value = mesesValue;

                            console.log('After setting - miles field value:', $('#proximo_mileage').val());
                            console.log('After setting - meses field value:', $('#proximoMeses').val());
                        }
                    }).fail(function(xhr, status, error) {
                        console.error('Error fetching maintenance type:', error);
                        console.error('Response:', xhr.responseText);
                    });
                } else {
                    $('#categoria').val('');
                    $('#proximo_mileage').val('');
                    $('#proximoMeses').val('');
                }
            });

            // Funci√≥n para mostrar mensaje
            function mostrarMensaje(mensaje, esExito) {
                const container = $('#mensajeContainer');
                const texto = $('#mensajeTexto');

                container.removeClass('alert-success alert-danger')
                        .addClass(esExito ? 'alert-success' : 'alert-danger');
                texto.text(mensaje);
                container.show();

                // Ocultar mensaje despu√©s de 5 segundos
                setTimeout(() => {
                    container.fadeOut();
                }, 5000);
            }

            // Funci√≥n para mostrar mensaje en el modal
            function mostrarMensajeModal(mensaje) {
                const container = $('#modalMensajeContainer');
                const texto = $('#modalMensajeTexto');
                texto.text(mensaje);
                container.show();
            }

            // Funci√≥n para ocultar mensaje del modal
            function ocultarMensajeModal() {
                $('#modalMensajeContainer').hide();
            }

            // Limpiar mensaje al abrir el modal
            $('#mecanicoModal').on('show.bs.modal', function() {
                ocultarMensajeModal();
            });

            // Funci√≥n para mostrar mensaje en el modal de tipo de mantenimiento
            function mostrarMensajeTipoMantenimiento(mensaje) {
                const container = $('#tipoMantenimientoMensajeContainer');
                const texto = $('#tipoMantenimientoMensajeTexto');
                texto.text(mensaje);
                container.show();
            }

            // Funci√≥n para ocultar mensaje del modal de tipo de mantenimiento
            function ocultarMensajeTipoMantenimiento() {
                $('#tipoMantenimientoMensajeContainer').hide();
            }

            // Limpiar mensaje al abrir el modal de tipo de mantenimiento
            $('#tipoMantenimientoModal').on('show.bs.modal', function() {
                ocultarMensajeTipoMantenimiento();
            });

            // Update the input validation for precio
            $('#precio').on('keypress', function(e) {
                // Allow only numbers and one decimal point
                if ((e.which < 48 || e.which > 57) && e.which !== 46) {
                    e.preventDefault();
                }
                // Ensure only one decimal point
                if (e.which === 46 && $(this).val().indexOf('.') !== -1) {
                    e.preventDefault();
                }
            });

            // Update paste handling for precio
            $('#precio').on('paste', function(e) {
                e.preventDefault();
                const text = (e.originalEvent.clipboardData || window.clipboardData).getData('text');
                // Replace any non-numeric or non-decimal characters, ensure only one decimal point
                const cleanedText = text.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');
                $(this).val(cleanedText);
            });
        });
    </script>
</body>
</html>
