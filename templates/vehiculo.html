<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle - {{ vehiculo.alias }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
        .table {
            width: 100%;
            margin-bottom: 1rem;
            background-color: transparent;
        }
        .text-danger {
            color: #dc3545 !important;
        }
        .fw-bold {
            font-weight: 700 !important;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-2">Vehicle - {{ vehiculo.alias }}</h1>
                <p class="mb-0 text-muted">{{ vehiculo.marca }} {{ vehiculo.modelo }} {{ vehiculo.anio }}</p>
                <p class="mb-0 text-muted small">
                    Last Mileage:
                    <span class="fw-bold">
                        {% if vehiculo.ultimo_kilometraje is not none %}
                            {{ "{:,.0f}".format(vehiculo.ultimo_kilometraje).replace(',', '.') }} km
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </p>
            </div>
            <div>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back</a>
                {% if g.user %}
                    <a href="{{ url_for('logout') }}" class="btn btn-danger ms-2">Logout ({{ g.user.username }})</a>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="filtroCategoria" class="form-label">Category</label>
                        <select id="filtroCategoria" class="form-select">
                            <option value="">All Categories</option>
                            {% for cat in tipos_mantenimiento|map(attribute='categoria')|unique %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="filtroTipo" class="form-label">Maintenance Type</label>
                        <select id="filtroTipo" class="form-select">
                            <option value="">All Types</option>
                            {% for tipo in tipos_mantenimiento %}
                            <option value="{{ tipo.nombre }}">{{ tipo.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="filtroMecanico" class="form-label">Mechanic</label>
                        <select id="filtroMecanico" class="form-select">
                            <option value="">All Mechanics</option>
                            {% for mecanico in mecanicos %}
                            <option value="{{ mecanico.nombre_mecanico }}">{{ mecanico.nombre_mecanico }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-8 mt-3">
                        <label for="searchInput" class="form-label">Search:</label>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search in all fields...">
                    </div>
                    <div class="col-md-4 mt-3 d-flex align-items-end">
                        <button id="limpiarFiltros" class="btn btn-secondary">Clear Filters</button>
                    </div>
                </div>

                <table id="tablaMantenimientos" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Mileage</th>
                            <th>Category</th>
                            <th>Maintenance Type</th>
                            <th>Mechanic</th>
                            <th>Price</th>
                            <th>Next Maintenance</th>
                            <th>Next Mileage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in mantenimientos %}
                        <tr>
                            <td data-order="{{ m.fecha_iso }}">{{ m.fecha }}</td>
                            <td>{{ "{:,.0f}".format(m.kilometraje).replace(',', '.') }}</td>
                            <td>{{ m.categoria }}</td>
                            <td>{{ m.tipo_mantenimiento }}</td>
                            <td>{{ m.mecanico }}</td>
                            <td>{{ "{:,.0f}".format(m.precio|int).replace(',', '.') if m.precio }}</td>
                            <td data-order="{{ m.fecha_proximo_iso if m.fecha_proximo_iso else '' }}"
                                {% if m.fecha_proximo_iso and m.fecha_proximo_iso < today_iso %}
                                    class="text-danger fw-bold"
                                {% endif %}>
                                {{ m.fecha_proximo if m.fecha_proximo else '' }}
                            </td>
                            <td data-order="{{ m.proximo_km if m.proximo_km else 999999999 }}"
                                {% if m.proximo_km and m.kilometraje > m.proximo_km %}
                                    class="text-danger fw-bold"
                                {% endif %}>
                                {{ "{:,.0f}".format(m.proximo_km).replace(',', '.') if m.proximo_km }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="mt-3 text-center">
            <button id="descargarDatos" class="btn btn-primary">Download Data</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        $(document).ready(function() {
            // Initialize DataTable
            var tabla = $('#tablaMantenimientos').DataTable({
                order: [[0, 'desc']],
                pageLength: 10,
                language: {
                    search: "Search:",
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    infoEmpty: "Showing 0 to 0 of 0 entries",
                    infoFiltered: "(filtered from _MAX_ total entries)",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                }
            });

            // Initialize Select2
            $('#filtroCategoria, #filtroTipo, #filtroMecanico').select2({
                width: '100%',
                placeholder: 'Select an option'
            });

            // Apply filters
            function aplicarFiltros() {
                var categoria = $('#filtroCategoria').val().toLowerCase();
                var tipo = $('#filtroTipo').val().toLowerCase();
                var mecanico = $('#filtroMecanico').val().toLowerCase();
                var busqueda = $('#searchInput').val().toLowerCase();

                $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                    var cumpleFiltros = true;

                    if (categoria && data[2].toLowerCase() !== categoria) cumpleFiltros = false;
                    if (tipo && data[3].toLowerCase() !== tipo) cumpleFiltros = false;
                    if (mecanico && data[4].toLowerCase() !== mecanico) cumpleFiltros = false;
                    
                    if (busqueda) {
                        var coincide = false;
                        for (var i = 0; i < data.length; i++) {
                            if (data[i].toLowerCase().includes(busqueda)) {
                                coincide = true;
                                break;
                            }
                        }
                        if (!coincide) cumpleFiltros = false;
                    }

                    return cumpleFiltros;
                });

                tabla.draw();
                $.fn.dataTable.ext.search.pop();
            }

            // Event listeners for filters
            $('#filtroCategoria, #filtroTipo, #filtroMecanico').on('change', aplicarFiltros);
            $('#searchInput').on('keyup', aplicarFiltros);

            // Clear filters
            $('#limpiarFiltros').click(function() {
                $('#filtroCategoria, #filtroTipo, #filtroMecanico').val(null).trigger('change');
                $('#searchInput').val('');
                aplicarFiltros();
            });

            // Download data
            $('#descargarDatos').click(function() {
                var data = [['Date', 'Mileage', 'Category', 'Maintenance Type', 'Mechanic', 'Price', 'Next Maintenance', 'Next Mileage']];
                
                tabla.rows({ search: 'applied' }).every(function() {
                    data.push(this.data());
                });

                var ws = XLSX.utils.aoa_to_sheet(data);
                var wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Maintenance History");
                XLSX.writeFile(wb, "maintenance_history.xlsx");
            });
        });
    </script>
</body>
</html>