<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        // For screens 1440px or less, set a zoomed-out view so that all columns are visible by default
        if (window.matchMedia("(max-width: 1440px)").matches) {
            var viewport = document.querySelector("meta[name=viewport]");
            if (viewport) {
                viewport.setAttribute("content", "width=device-width, initial-scale=0.5");
            }
        }
    </script>
    <title>Maintenance - {{ vehiculo.alias }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
        #tablaMantenimientos {
            border: none;
        }

        #tablaMantenimientos th,
        #tablaMantenimientos td {
            border: none;
        }

        #tablaMantenimientos thead th {
            border-bottom: 2px solid #dee2e6;
        }

        /* Remove card borders */
        .card {
            border: none;
            box-shadow: none;
        }

        /* Remove DataTable controls borders */
        .dataTables_wrapper .row:first-child,
        .dataTables_wrapper .row:last-child {
            border: none;
            margin: 0;
            padding: 0;
        }

        /* Remove spacing between elements */
        .dataTables_wrapper .row {
            margin: 0;
        }

        /* Center main container */
        .container.mt-4 {
            margin-left: auto !important;
            margin-right: auto !important;
            text-align: left;
        }

        @media (max-width: 1440px) {
            /* Left align main container on devices with widths up to 1440px */
            .container.mt-4 {
                margin-left: 0 !important;
                margin-right: auto !important;
            }
        }

        /* Style for the search box */
        .search-container {
            margin-bottom: 20px;
        }

        #searchInput {
            width: 100%;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-2">Maintenance - {{ vehiculo.alias }}</h1>
                <p class="mb-0 text-muted">{{ vehiculo.marca }} {{ vehiculo.modelo }} {{ vehiculo.anio }}</p>
                <p class="mb-0 text-muted small">
                    Last Mileage:
                    <span class="fw-bold">
                        {% if vehiculo.ultimo_kilometraje is not none %}
                            {{ "{:,.0f}".format(vehiculo.ultimo_kilometraje).replace(',', '.') }} km
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </p>
            </div>
            <div>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back</a>
                {% if g.user %}
                    <a href="{{ url_for('logout') }}" class="btn btn-danger ms-2">Logout ({{ g.user.username }})</a>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="filtroCategoria" class="form-label">Category</label>
                        <select id="filtroCategoria" class="form-select">
                            <option value="">All categories</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="filtroTipo" class="form-label">Maintenance Type</label>
                        <select id="filtroTipo" class="form-select">
                            <option value="">All types</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="filtroMecanico" class="form-label">Mechanic</label>
                        <select id="filtroMecanico" class="form-select">
                            <option value="">All mechanics</option>
                        </select>
                    </div>
                    <div class="col-md-8 mt-3">
                        <label for="searchInput" class="form-label">Search:</label>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search in all fields...">
                    </div>
                    <div class="col-md-4 mt-3 d-flex align-items-end">
                        <button id="limpiarFiltros" class="btn btn-secondary">Clear Filters</button>
                    </div>
                </div>

                <h4 class="mb-3">Recent Maintenance</h4>
                <table id="tablaMantenimientos" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Mileage</th>
                            <th>Category</th>
                            <th>Maintenance Type</th>
                            <th>Mechanic</th>
                            <th>Price</th>
                            <th>Next Maintenance</th>
                            <th>Next Mileage</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- This table will be filled with JavaScript -->
                    </tbody>
                </table>

                <h4 class="mt-5 mb-3">Repeated Maintenance</h4>
                <table id="tablaMantenimientosRepetidos" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Mileage</th>
                            <th>Category</th>
                            <th>Maintenance Type</th>
                            <th>Mechanic</th>
                            <th>Price</th>
                            <th>Next Maintenance</th>
                            <th>Next Mileage</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- This table will be filled with JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="mt-3 text-center">
            <button id="descargarDatos" class="btn btn-primary">Download Data</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        $(document).ready(function() {
            // Prepare data to split into two tables
            var mantenimientos = [];

            {% for m in mantenimientos %}
            mantenimientos.push({
                fecha: "{{ m.fecha }}",
                fecha_iso: "{{ m.fecha_iso }}",
                kilometraje: {{ m.kilometraje }},
                categoria: "{{ m.categoria }}",
                tipo_mantenimiento: "{{ m.tipo_mantenimiento }}",
                mecanico: "{{ m.mecanico }}",
                precio: "{% if m.precio %}{{ m.precio|int }}{% endif %}",
                fecha_proximo: "{{ m.fecha_proximo }}",
                fecha_proximo_iso: "{{ m.fecha_proximo_iso|default('') }}",
                proximo_km: {% if m.proximo_km %}{{ m.proximo_km }}{% else %}null{% endif %},
                today_iso: "{{ today_iso }}"
            });
            {% endfor %}

            // Sort by maintenance type and date (most recent first)
            mantenimientos.sort(function(a, b) {
                if (a.tipo_mantenimiento === b.tipo_mantenimiento) {
                    return b.fecha_iso.localeCompare(a.fecha_iso);
                }
                return a.tipo_mantenimiento.localeCompare(b.tipo_mantenimiento);
            });

            // Separate into latest and repeated
            var ultimosMantenimientos = [];
            var mantenimientosRepetidos = [];
            var tiposVistos = {};

            mantenimientos.forEach(function(m) {
                if (!tiposVistos[m.tipo_mantenimiento]) {
                    ultimosMantenimientos.push(m);
                    tiposVistos[m.tipo_mantenimiento] = true;
                } else {
                    mantenimientosRepetidos.push(m);
                }
            });

            // Function to fill a table with data
            function llenarTabla(tablaId, datos) {
                var tbody = $(tablaId + ' tbody');
                tbody.empty();

                datos.forEach(function(m) {
                    var row = '<tr>' +
                        '<td data-order="' + m.fecha_iso + '">' + m.fecha + '</td>' +
                        '<td>' + m.kilometraje + '</td>' +
                        '<td>' + m.categoria + '</td>' +
                        '<td>' + m.tipo_mantenimiento + '</td>' +
                        '<td>' + m.mecanico + '</td>' +
                        '<td>' + m.precio + '</td>' +
                        '<td data-order="' + (m.fecha_proximo_iso || '') + '"' +
                        (m.fecha_proximo_iso && m.fecha_proximo_iso < m.today_iso ? ' class="text-danger fw-bold"' : '') +
                        '>' + m.fecha_proximo + '</td>' +
                        '<td data-order="' + (m.proximo_km || 999999999) + '"' +
                        (m.proximo_km && m.kilometraje > m.proximo_km ? ' class="text-danger fw-bold"' : '') +
                        '>' + (m.proximo_km || '') + '</td>' +
                        '</tr>';
                    tbody.append(row);
                });

                // Initialize DataTable
                if (!$.fn.DataTable.isDataTable(tablaId)) {
                    $(tablaId).DataTable({
                        order: [[0, 'desc']],
                        pageLength: 10,
                        language: {
                            search: "Search:",
                            lengthMenu: "Show _MENU_ entries",
                            info: "Showing _START_ to _END_ of _TOTAL_ entries",
                            infoEmpty: "Showing 0 to 0 of 0 entries",
                            infoFiltered: "(filtered from _MAX_ total entries)",
                            paginate: {
                                first: "First",
                                last: "Last",
                                next: "Next",
                                previous: "Previous"
                            }
                        }
                    });
                } else {
                    $(tablaId).DataTable().draw();
                }
            }

            // Fill both tables
            llenarTabla('#tablaMantenimientos', ultimosMantenimientos);
            llenarTabla('#tablaMantenimientosRepetidos', mantenimientosRepetidos);

            // Populate filter options
            var categorias = [...new Set(mantenimientos.map(m => m.categoria))].sort();
            var tipos = [...new Set(mantenimientos.map(m => m.tipo_mantenimiento))].sort();
            var mecanicos = [...new Set(mantenimientos.map(m => m.mecanico))].sort();

            categorias.forEach(function(cat) {
                $('#filtroCategoria').append($('<option>', {
                    value: cat,
                    text: cat
                }));
            });

            tipos.forEach(function(tipo) {
                $('#filtroTipo').append($('<option>', {
                    value: tipo,
                    text: tipo
                }));
            });

            mecanicos.forEach(function(mec) {
                $('#filtroMecanico').append($('<option>', {
                    value: mec,
                    text: mec
                }));
            });

            // Apply filters
            function aplicarFiltros() {
                var categoria = $('#filtroCategoria').val();
                var tipo = $('#filtroTipo').val();
                var mecanico = $('#filtroMecanico').val();
                var busqueda = $('#searchInput').val().toLowerCase();

                var datosFiltrados = mantenimientos.filter(function(m) {
                    return (!categoria || m.categoria === categoria) &&
                           (!tipo || m.tipo_mantenimiento === tipo) &&
                           (!mecanico || m.mecanico === mecanico) &&
                           (!busqueda || 
                            m.fecha.toLowerCase().includes(busqueda) ||
                            m.kilometraje.toString().includes(busqueda) ||
                            m.categoria.toLowerCase().includes(busqueda) ||
                            m.tipo_mantenimiento.toLowerCase().includes(busqueda) ||
                            m.mecanico.toLowerCase().includes(busqueda) ||
                            (m.precio && m.precio.toString().includes(busqueda)) ||
                            (m.fecha_proximo && m.fecha_proximo.toLowerCase().includes(busqueda)) ||
                            (m.proximo_km && m.proximo_km.toString().includes(busqueda)));
                });

                // Separate filtered data
                var ultimosFiltrados = [];
                var repetidosFiltrados = [];
                var tiposVistos = {};

                datosFiltrados.forEach(function(m) {
                    if (!tiposVistos[m.tipo_mantenimiento]) {
                        ultimosFiltrados.push(m);
                        tiposVistos[m.tipo_mantenimiento] = true;
                    } else {
                        repetidosFiltrados.push(m);
                    }
                });

                // Update tables
                llenarTabla('#tablaMantenimientos', ultimosFiltrados);
                llenarTabla('#tablaMantenimientosRepetidos', repetidosFiltrados);
            }

            // Event listeners for filters
            $('#filtroCategoria, #filtroTipo, #filtroMecanico').change(aplicarFiltros);
            $('#searchInput').on('keyup', aplicarFiltros);

            // Clear filters
            $('#limpiarFiltros').click(function() {
                $('#filtroCategoria, #filtroTipo, #filtroMecanico').val('');
                $('#searchInput').val('');
                aplicarFiltros();
            });

            // Download data
            $('#descargarDatos').click(function() {
                var wb = XLSX.utils.book_new();
                
                // Convert data for latest maintenance
                var wsData1 = [
                    ['Date', 'Mileage', 'Category', 'Maintenance Type', 'Mechanic', 'Price', 'Next Maintenance', 'Next Mileage']
                ];
                ultimosMantenimientos.forEach(function(m) {
                    wsData1.push([
                        m.fecha,
                        m.kilometraje,
                        m.categoria,
                        m.tipo_mantenimiento,
                        m.mecanico,
                        m.precio,
                        m.fecha_proximo,
                        m.proximo_km
                    ]);
                });
                var ws1 = XLSX.utils.aoa_to_sheet(wsData1);
                XLSX.utils.book_append_sheet(wb, ws1, "Latest Maintenance");

                // Convert data for repeated maintenance
                var wsData2 = [
                    ['Date', 'Mileage', 'Category', 'Maintenance Type', 'Mechanic', 'Price', 'Next Maintenance', 'Next Mileage']
                ];
                mantenimientosRepetidos.forEach(function(m) {
                    wsData2.push([
                        m.fecha,
                        m.kilometraje,
                        m.categoria,
                        m.tipo_mantenimiento,
                        m.mecanico,
                        m.precio,
                        m.fecha_proximo,
                        m.proximo_km
                    ]);
                });
                var ws2 = XLSX.utils.aoa_to_sheet(wsData2);
                XLSX.utils.book_append_sheet(wb, ws2, "Repeated Maintenance");

                // Save the file
                XLSX.writeFile(wb, "maintenance_history.xlsx");
            });
        });
    </script>
</body>
</html>